name: Build

on:
  push:
    branches-ignore:
      - "dependabot/*"
  pull_request:

jobs:
  build-alpine:
    name: Alpine ${{ matrix.Configuration }} ${{ matrix.Platform }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        Configuration: [Debug, Release]
        Platform: [x86_64, x86]

    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Deinit Crypto++
      run: |
        git submodule deinit Externals/cryptopp

    - name: Install latest Alpine Linux for ${{ matrix.ARCH }}
      uses: jirutka/setup-alpine@v1
      with:
        arch: ${{ matrix.Platform }}
        branch: 'latest-stable'
        packages: build-base binutils-gold cmake sdl2-dev glew-dev lzo-dev libjpeg-turbo-dev openal-soft-dev libogg-dev libtheora-dev libvorbis-dev

    - name: Create build directory
      run: mkdir build

    - name: Run CMake x64
      if: ${{ matrix.Platform == 'x86_64' }}
      working-directory: build
      shell: alpine.sh {0}
      run: CFLAGS="-w" CXXFLAGS="-w" cmake .. -DCMAKE_BUILD_TYPE=${{ matrix.Configuration }}

    - name: Run CMake x86
      if: ${{ matrix.Platform == 'x86' }}
      working-directory: build
      shell: alpine.sh {0}
      run: CFLAGS="-m32 -w" CXXFLAGS="-m32 -w" cmake .. -DCMAKE_BUILD_TYPE=${{ matrix.Configuration }} -DCMAKE_ASM_FLAGS=-m32

    - name: Run Make
      working-directory: build
      shell: alpine.sh {0}
      run: make
