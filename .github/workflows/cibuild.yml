name: Build

on:
  push:
    branches-ignore:
      - "dependabot/*"
  pull_request:

jobs:
  build-windows:
    name: Windows ${{ matrix.Configuration }} ${{ matrix.Platform }} (msvc)
    runs-on: windows-2019
    strategy:
      fail-fast: false
      matrix:
        Configuration: [Debug, Mixed, Release, Release Master Gold]
        Platform: [x64, x86]
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive

    - name: Add msbuild to PATH
      uses: microsoft/setup-msbuild@v1.0.2

    - name: Setup NuGet.exe
      uses: nuget/setup-nuget@v1
      with:
        nuget-version: '5.x'

    - name: Restore NuGet packages
      run: nuget restore src\engine.sln

    - name: MSBuild
      working-directory: src
      run: msbuild /p:Configuration="${{ matrix.Configuration }}" /p:Platform="${{ matrix.Platform }}" engine.sln

    - name: Prepare artifacts
      id: windows-vars
      shell: cmd
      run: |
        set CONFIGURATION=${{ matrix.Configuration }}
        set PLATFORM=${{ matrix.Platform }}
        call xr_pack_build.cmd ARTIFACT_EDITION
        echo ::set-output name=Build_type::%ARTIFACT_EDITION%

    - name: Upload OpenXRay artifact
      uses: actions/upload-artifact@v2
      with:
        name: OpenXRay.${{ steps.windows-vars.outputs.Build_type }}.7z
        path: res\OpenXRay.${{ steps.windows-vars.outputs.Build_type }}.7z

    - name: Upload Symbols
      uses: actions/upload-artifact@v2
      with:
        name: Symbols.${{ steps.windows-vars.outputs.Build_type }}.7z
        path: res\Symbols.${{ steps.windows-vars.outputs.Build_type }}.7z

    - name: Upload Utils
      uses: actions/upload-artifact@v2
      with:
        name: Utils.${{ steps.windows-vars.outputs.Build_type }}.7z
        path: res\Utils.${{ steps.windows-vars.outputs.Build_type }}.7z

  build-ubuntu:
    name: Ubuntu ${{ matrix.Configuration }} ${{ matrix.Platform }} (${{ matrix.CC }})
    runs-on: ubuntu-18.04
    strategy:
      fail-fast: false
      matrix:
        Configuration: [Debug, Release]
        Platform: [x64, x86]
        CC: [gcc-9, clang-9]
        include:
          - CC: gcc-9
            CXX: g++-9
          - CC: clang-9
            CXX: clang++-9

    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Deinit Crypto++
      run: |
        git submodule deinit Externals/cryptopp

    - name: Install x64 packages
      if: ${{ matrix.Platform == 'x64' }}
      run: |
          sudo apt-get update -qq
          sudo apt-get install -qq -y libsdl2-dev libglew-dev liblzo2-dev libjpeg-dev &&
          sudo apt-get install -qq -y libopenal-dev libogg-dev libtheora-dev libvorbis-dev

    - name: Install x86 packages
      if: ${{ matrix.Platform == 'x86' }}
      run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update -qq
          sudo apt-get install -qq -y libsdl2-dev:i386 libglew-dev:i386 liblzo2-dev:i386 libjpeg-dev:i386 &&
          sudo apt-get install -qq -y libopenal-dev:i386 libogg-dev:i386 libtheora-dev:i386 libvorbis-dev:i386 &&

    - name: Install GCC x64
      if: ${{ matrix.Platform == 'x64' && matrix.CC == 'gcc-9' }}
      run: sudo apt-get install -qq -y gcc-9

    - name: Install GCC x86
      if: ${{ matrix.Platform == 'x86' && matrix.CC == 'gcc-9' }}
      run: sudo apt-get install -qq -y gcc-multilib g++-9-multilib

    - name: Install Clang x64
      if: ${{ matrix.Platform == 'x64' && matrix.CC == 'clang-9' }}
      run: sudo apt-get install -qq -y clang-9 libc++-9-dev libc++abi-9-dev lld

    - name: Install Clang x86
      if: ${{ matrix.Platform == 'x86' && matrix.CC == 'clang-9' }}
      run: sudo apt-get install -qq -y clang-9:i386 libc++-9-dev:i386 libc++abi-9-dev:i386 lld:i386

    - name: Prepare build
      run: |
          export CC=${{ matrix.CC }}
          export CXX=${{ matrix.CXX }}
          ${CXX} --version
          export core_count=$(nproc || echo 4) && echo core_count = $core_count
          mkdir build

    - name: Run CMake x64
      if: ${{ matrix.Platform == 'x64' }}
      working-directory: build
      run: CFLAGS="-w" CXXFLAGS="-w" cmake .. -DCMAKE_BUILD_TYPE=${{ matrix.Configuration }}

    - name: Run CMake x86
      if: ${{ matrix.Platform == 'x86' }}
      working-directory: build
      run: CFLAGS="-m32 -w" CXXFLAGS="-m32 -w" cmake .. -DCMAKE_BUILD_TYPE=${{ matrix.Configuration }} -DCPACK_DEBIAN_PACKAGE_ARCHITECTURE=i386 -DCMAKE_ASM_FLAGS=-m32

    - name: Run Make
      working-directory: build
      run: |
        pwd
        make -j $core_count package
        file openxray_1.6.02_*.deb

    - name: Upload OpenXRay artifact
      if: ${{ matrix.Platform == 'x64' }}
      uses: actions/upload-artifact@v2
      with:
        name: openxray_1.6.02_${{ matrix.Configuration }}_amd64.deb
        path: bin/openxray_1.6.02_amd64.deb

    - name: Upload OpenXRay artifact
      if: ${{ matrix.Platform == 'x86' }}
      uses: actions/upload-artifact@v2
      with:
        name: openxray_1.6.02_${{ matrix.Configuration }}_i386.deb
        path: bin/openxray_1.6.02_i386.deb
