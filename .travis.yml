language: cpp
cache: ccache
os: [linux, freebsd]
dist: focal
compiler: gcc
env: [Debug, Release]

branches:
  except:
    - /^dependabot\/.*$/

addons:
  apt:
    update: true
    packages: &required_packages
      - [libsdl2-dev libglew-dev liblzo2-dev libjpeg-dev libopenal-dev libogg-dev libtheora-dev libvorbis-dev]
  pkg:
    - [sdl2, glew, lzo2, jpeg-turbo, openal-soft, libogg, libtheora, libvorbis]

jobs:
  include:
    - arch: arm64-graviton2
      virt: lxd
      group: edge

before_script:
  - if [ $TRAVIS_CPU_ARCH == arm64 ]; then
        export core_count=2;
    else
        export core_count=$(nproc || echo 2);
    fi
  - echo core_count = $core_count
  - git submodule deinit Externals/cryptopp
  - CFLAGS="-w" CXXFLAGS="-w" cmake -B build -DCMAKE_BUILD_TYPE=$BUILD_CONFIGURATION -DCMAKE_UNITY_BUILD=ON

script:
- cmake --build build -j $core_count
- if [ $TRAVIS_OS_NAME == linux ]; then
      make -j $core_count package;
      file openxray_1.6.02_*.deb;
  fi

deploy:
  provider: releases
  token:
    secure: kGVniXDR926BfVcA97y25BzALbijvgboBsozZzY9yc8RPz15Q4YG474h7vl14/J1
  file: ./*.deb
  draft: true

notifications:
  email: false
