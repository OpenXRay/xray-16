language: cpp
cache: ccache
os: linux
dist: focal
      
branches:
  except:
    - /^dependabot\/.*$/

addons:
  apt:
    update: true
    packages: &required_packages
      - [libsdl2-dev libglew-dev liblzo2-dev libjpeg-dev libopenal-dev libogg-dev libtheora-dev libvorbis-dev]


jobs:
  include:
    - arch: arm64-graviton2
      virt: lxd
      group: edge
      compiler: gcc
      env: TARGET_CPU=x64 BUILD_CONFIGURATION=Release
      addons:
        apt:
          packages:
            - *required_packages

    - arch: arm64-graviton2
      virt: lxd
      group: edge
      compiler: gcc
      env: TARGET_CPU=x64 BUILD_CONFIGURATION=Debug
      addons:
        apt:
          packages:
            - *required_packages

before_script:
  - if [ $TRAVIS_CPU_ARCH == arm64 ]; then
        export core_count=2 && echo core_count = $core_count;
    else
        export core_count=$(nproc || echo 4) && echo core_count = $core_count;
    fi
  - git submodule deinit Externals/cryptopp
  - cmake -B build -D$BUILD_CONFIGURATION -DCMAKE_UNITY_BUILD=ON;

script:
- CFLAGS="-w" CXXFLAGS="-w" cmake --build build --parallel $core_count
- if [ $TRAVIS_OS_NAME == linux ]; then
      make -j $core_count package
      file openxray_1.6.02_*.deb;
  fi

deploy:
  provider: releases
  token:
    secure: kGVniXDR926BfVcA97y25BzALbijvgboBsozZzY9yc8RPz15Q4YG474h7vl14/J1
  file: ./*.deb
  draft: true

notifications:
  email: false
